<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WORLD MACHINE</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Genos:ital,wght@0,100;0,400;0,700;1,400&family=VT323&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS (Optional, if used for quick prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js library for 3D visualization -->
    <link rel="stylesheet" href="style2.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
      /* --- CSS Variable Definitions (Colors, Radii, etc.) --- */
      :root {
        /* Color Scheme */
        --bg-color: #0a0a0a; /* Background color */
        --text-color: #e0e0e0; /* Main text color */
        --accent-color: #ff6bce; /* Pink accent */
        --highlight-color: #ff9ad5; /* Lighter pink */
        --secondary-color: #ffd166; /* Yellow for contrast */
        --dark-accent: #6a0dad; /* Deep purple */
        --button-bg: #1a1a1a; /* Button background */
        --border-color: var(--accent-color); /* Border color */
        --console-bg: rgba(15, 15, 15, 0.9); /* Console background */
        --question-color: #ff9ad5; /* Question text color */
        --area-color: #ff6bce; /* Color related to the zone */
        --mode-color: #ffd166; /* Color related to the mode */
        --matrix-color: #00ff41; /* Green matrix color */

        /* Colors for individual zones (for JS use) */
        --environment-color: #4caf50;
        --physics-color: #2196f3;
        --interactions-color: #ff9800;
        --economy-color: #9c27b0;
        --history-color: #607d8b;
        --time-color: #00bcd4;
        --lore-color: #e91e63;
        --energy-color: #ffeb3b; /* Added color for Energy */
        --tech-color: #3f51b5;
        --anomalies-color: #8bc34a;
        --affects-color: #ff5722;

        /* Layout & Effects */
        --border-radius: 6px; /* Corner rounding radius */
        --glow-intensity: 0 0 10px; /* Glow intensity */
      }

      /* --- Global Styles --- */
      * {
        box-sizing: border-box; /* Box model */
        font-family: "VT323", monospace; /* Default font */
        margin: 0;
        padding: 0;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6; /* Line spacing */
        padding: 20px; /* Body inner margin */
        max-width: 1400px; /* Maximum content width */
        margin: 0 auto; /* Center content */
        font-size: 20px; /* Default font size */
        text-shadow: var(--glow-intensity) rgba(255, 107, 206, 0.2); /* Slight text glow */
        min-height: 100vh; /* Minimum body height */
        /* Subtle background gradient */
        background-image: radial-gradient(
            circle at 10% 20%,
            rgba(255, 107, 206, 0.05) 0%,
            transparent 20%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(106, 13, 173, 0.05) 0%,
            transparent 20%
          );
        /* Grid layout for main containers */
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two equal columns */
        gap: 20px; /* Gap between columns */
      }

      /* --- Media Query for smaller screens (single-column layout) --- */
      @media (max-width: 1024px) {
        body {
          grid-template-columns: 1fr; /* Single column */
        }
      }

      /* --- Main Container Styles (left column) --- */
      .container {
        border: 2px solid var(--accent-color);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 0 20px rgba(255, 107, 206, 0.3); /* Glow around the container */
        background-color: var(--console-bg); /* Semi-transparent background */
        position: relative;
        z-index: 1;
        backdrop-filter: blur(2px); /* Blur background behind the container */
        grid-column: 1; /* Placement in the first grid column */
      }

      /* --- Matrix Container Styles (right column) --- */
      .matrix-container {
        border: 2px solid var(--matrix-color);
        border-radius: var(--border-radius);
        padding: 0; /* Padding removed, it's in <details> */
        margin-bottom: 25px;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3); /* Green glow */
        background-color: rgba(0, 10, 5, 0.9); /* Dark green background */
        position: relative;
        z-index: 1;
        backdrop-filter: blur(2px);
        grid-column: 2; /* Placement in the second grid column */
        /* Removed flex, height, sticky - <details> will handle this */
      }

      /* Styling for the <summary> element (Matrix section title) */
      .matrix-container summary {
        padding: 20px; /* Added padding here */
        cursor: pointer;
        outline: none;
        list-style: none; /* Hide default marker */
        text-align: center;
        font-family: "VT323", monospace;
        font-size: 1.8rem;
        color: var(--matrix-color);
        text-shadow: 0 0 10px var(--matrix-color);
        letter-spacing: 2px;
        border-bottom: 1px dashed rgba(0, 255, 65, 0.3); /* Separator line when collapsed */
      }
      .matrix-container details[open] summary {
        border-bottom: none; /* Remove line when expanded */
      }

      /* Styling for the default <details> marker (if browser adds one) */
      .matrix-container summary::-webkit-details-marker {
        display: none;
      }
      .matrix-container summary::marker {
        /* Standard way */
        display: none;
      }

      /* Container for <details> content */
      .matrix-content {
        padding: 20px; /* Padding for the content */
        border-top: 1px solid var(--matrix-color); /* Separator line from summary */
        display: flex;
        flex-direction: column;
        /* Set height for the content when <details> is open */
        /* Can be adjusted or removed if height should be auto */
        height: calc(100vh - 120px); /* Example height, adjust as needed */
        min-height: 500px; /* Minimum content height */
      }

      /* --- Media Query for matrix container on smaller screens --- */
      @media (max-width: 1024px) {
        .matrix-container {
          grid-column: 1; /* In single-column layout, occupies the first (and only) column */
          /* Removed height: auto and position: static - unnecessary for <details> */
        }
        .matrix-content {
          height: auto; /* Auto height on smaller screens */
          min-height: 400px;
        }
      }

      /* --- Container for 3D Visualization (Three.js) --- */
      #matrix3d {
        flex-grow: 1; /* Stretches to fill available space */
        width: 100%;
        /* min-height removed, height managed by .matrix-content */
        border: 1px solid var(--matrix-color);
        margin-bottom: 15px;
        /* Three.js will create its <canvas> element here */
      }

      /* --- Matrix Controls (Input + Button) --- */
      .matrix-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .matrix-input {
        flex-grow: 1; /* Input takes most space */
        background: rgba(0, 20, 10, 0.7);
        border: 1px solid var(--matrix-color);
        color: var(--matrix-color);
        padding: 10px;
        font-family: "VT323", monospace;
        font-size: 1.2rem;
      }

      .matrix-input:focus {
        outline: none; /* Remove default focus outline */
        box-shadow: 0 0 10px var(--matrix-color); /* Glow on focus */
      }

      .matrix-submit {
        background: rgba(0, 30, 15, 0.7);
        border: 1px solid var(--matrix-color);
        color: var(--matrix-color);
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.3s; /* Smooth transition */
      }

      .matrix-submit:hover {
        background: var(--matrix-color);
        color: black; /* Change text color for contrast */
        text-shadow: 0 0 5px white; /* Slight white text glow */
      }

      /* --- Matrix Data Display Area --- */
      .matrix-data {
        max-height: 200px; /* Max height, scrollbar appears */
        overflow-y: auto; /* Vertical scrollbar only when needed */
        border: 1px solid var(--matrix-color);
        padding: 10px;
        background: rgba(0, 10, 5, 0.5);
        font-size: 0.9rem; /* Smaller font */
        color: var(--matrix-color);
        /* flex-grow: 0; */ /* Prevents excessive stretching */
        flex-shrink: 0; /* Prevents shrinking */
      }

      /* Scrollbar style for Webkit (Chrome, Safari) */
      .matrix-data::-webkit-scrollbar {
        width: 5px;
      }

      .matrix-data::-webkit-scrollbar-thumb {
        background: var(--matrix-color);
      }

      /* Matrix section title - moved to <summary> */
      /* .matrix-title { ... } */

      /* --- Page Header --- */
      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 15px;
        background: linear-gradient(
          to right,
          transparent,
          rgba(106, 13, 173, 0.3),
          transparent
        ); /* Gradient background */
        border-radius: var(--border-radius);
        border-bottom: 1px solid var(--accent-color);
        position: relative;
        overflow: hidden; /* Hide overflowing elements */
      }

      /* Animated line in the header */
      header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          to right,
          transparent,
          var(--accent-color),
          transparent
        );
        animation: headerGlow 3s infinite; /* Glow animation */
      }

      @keyframes headerGlow {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 1;
        }
      }

      /* Main Page Title */
      h1 {
        font-family: "Genos", sans-serif; /* Different font for H1 */
        font-size: 3rem;
        font-weight: 700;
        color: var(--accent-color);
        letter-spacing: 2px;
        text-shadow: 0 0 15px rgba(255, 107, 206, 0.7);
        margin: 0;
        text-transform: uppercase; /* Uppercase letters */
        position: relative;
      }

      /* Subtitle */
      .subtitle {
        font-family: "VT323", monospace;
        font-size: 1.4rem;
        color: var(--highlight-color);
        margin-top: 5px;
        letter-spacing: 1px;
      }

      /* H2 Headers (e.g., Session History) */
      h2 {
        font-size: 1.6rem;
        color: var(--highlight-color);
        margin: 25px 0 15px 0;
        border-bottom: 1px solid var(--accent-color);
        padding-bottom: 6px;
        font-family: "Genos", sans-serif;
        font-weight: 400;
        letter-spacing: 1px;
      }

      /* --- Control Panel (Main Buttons) --- */
      .control-panel {
        display: flex;
        flex-wrap: wrap; /* Wrap buttons on smaller screens */
        gap: 12px;
        margin-bottom: 20px;
        justify-content: center; /* Center buttons */
      }

      /* --- Button Styles --- */
      button {
        background-color: var(--button-bg);
        color: var(--text-color);
        border: 1px solid var(--accent-color);
        border-radius: var(--border-radius);
        padding: 8px 16px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px; /* Minimum width */
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
        letter-spacing: 1px;
      }

      /* Extra border for hover effect */
      button::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 1px solid var(--accent-color);
        border-radius: var(--border-radius);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      /* Hover effect for active buttons */
      button:hover:not(:disabled) {
        background-color: var(--dark-accent); /* Background change */
        color: var(--highlight-color); /* Text color change */
        text-shadow: 0 0 8px var(--highlight-color); /* Text glow */
        box-shadow: 0 0 15px rgba(255, 107, 206, 0.5); /* Button glow */
      }

      /* Activate extra border and animation on hover */
      button:hover:not(:disabled)::before {
        opacity: 1;
        animation: buttonBorderPulse 2s infinite;
      }

      /* Border pulsing animation */
      @keyframes buttonBorderPulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 0.3;
        }
      }

      /* Style for disabled buttons */
      button:disabled {
        opacity: 0.3; /* Reduced visibility */
        cursor: not-allowed; /* Not-allowed cursor */
        border-color: #444;
        color: #555;
      }

      /* --- Placeholder for ASCII Animation --- */
      #ascii-animation {
        font-family: "VT323", monospace;
        white-space: pre; /* Preserve whitespace (spaces, newlines) */
        color: var(--highlight-color);
        font-size: 1.2rem;
        line-height: 1.1;
        text-align: center;
        margin: 15px auto 25px auto;
        height: 30px; /* Fixed height */
        display: flex;
        justify-content: center;
        align-items: center;
        text-shadow: 0 0 8px var(--highlight-color);
      }

      /* --- Output Console --- */
      .console {
        background-color: var(--console-bg);
        border: 1px solid var(--accent-color);
        border-radius: var(--border-radius);
        padding: 15px;
        height: 350px; /* Fixed height */
        overflow-y: auto; /* Scrollbar */
        margin-bottom: 20px;
        position: relative;
        font-family: "VT323", monospace;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.7); /* Inner shadow */
        font-size: 1.1rem;
        line-height: 1.4;
      }

      /* Console scrollbar styles */
      .console::-webkit-scrollbar {
        width: 8px;
      }
      .console::-webkit-scrollbar-track {
        background: #111;
      }
      .console::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: var(--border-radius);
      }
      .console::-webkit-scrollbar-thumb:hover {
        background: var(--highlight-color);
      }

      /* Single line in the console */
      .console-line {
        margin-bottom: 10px;
        display: flex;
        user-select: none; /* Text cannot be selected by default (for typing effect) */
        animation: fadeIn 0.3s ease; /* Fade-in animation */
      }

      /* Line fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Allow text selection after typing is finished */
      .console-line.finished-typing {
        user-select: text;
      }

      /* Prompt (e.g., '>') in the console */
      .console-prompt {
        color: var(--accent-color);
        margin-right: 10px;
        flex-shrink: 0; /* Prevents the prompt from shrinking */
      }

      /* Text in the console line */
      .console-text {
        flex: 1; /* Takes up the rest of the available space */
        white-space: pre-wrap; /* Wrap text */
        word-break: break-word; /* Break long words */
      }

      /* Special style for question text */
      .question-text {
        color: var(--question-color);
        text-shadow: 0 0 8px rgba(255, 154, 213, 0.5);
      }

      /* Blinking cursor effect during typing */
      .typing::after {
        content: "▋"; /* Cursor character */
        display: inline-block;
        animation: blink 1s step-end infinite; /* Blinking animation */
        color: var(--highlight-color);
        margin-left: 2px;
        vertical-align: baseline;
      }

      /* Cursor blinking animation */
      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }

      /* --- Info Blocks (Zone Info, Zone Description, Hint) --- */
      .area-info,
      .hint,
      .area-description {
        border-left: 3px solid; /* Left border */
        padding: 10px 15px;
        margin: 20px 0;
        border-radius: 0 var(--border-radius) var(--border-radius) 0; /* Round only right corners */
        background-color: rgba(30, 30, 30, 0.6);
        font-style: italic; /* Italic */
        animation: fadeIn 0.5s ease; /* Fade-in animation */
      }

      .area-info {
        /* Displays the zone name */
        border-color: var(--area-color); /* Default color, changed by JS */
        color: var(--highlight-color);
        font-style: normal; /* Name doesn't need to be italic */
        font-weight: bold;
      }

      .area-description {
        /* Displays the zone description */
        border-color: var(--area-color); /* Default color, changed by JS */
        color: var(--text-color); /* Normal text color for description */
        font-size: 0.95rem;
        line-height: 1.4;
        font-style: normal;
      }

      .hint {
        /* Displays the hint */
        border-color: var(--secondary-color);
        color: var(--secondary-color);
      }

      /* --- Session History Section --- */
      .history {
        border-top: 1px dashed var(--accent-color); /* Separator line */
        padding-top: 20px;
        margin-top: 30px;
      }

      /* History log container */
      #history-log {
        max-height: 300px; /* Maximum height */
        overflow-y: auto; /* Scrollbar */
        padding-right: 10px; /* Space for scrollbar */
      }

      /* History scrollbar styles */
      #history-log::-webkit-scrollbar {
        width: 6px;
      }
      #history-log::-webkit-scrollbar-track {
        background: #111;
      }
      #history-log::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 3px;
      }
      #history-log::-webkit-scrollbar-thumb:hover {
        background: var(--highlight-color);
      }

      /* Single history item */
      .history-item {
        margin-bottom: 12px;
        padding: 10px;
        border-left: 2px solid var(--accent-color); /* Default color, changed by JS */
        background-color: rgba(25, 25, 25, 0.5);
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        font-size: 1rem; /* Smaller font than console */
        border-radius: 0 var(--border-radius) var(--border-radius) 0;
        transition: all 0.3s ease; /* Smooth transition for hover */
        animation: fadeIn 0.5s ease;
      }

      /* Hover effect for history item */
      .history-item:hover {
        background-color: rgba(40, 40, 40, 0.6);
        transform: translateX(5px); /* Slight shift to the right */
      }

      /* Text within history item */
      .history-item .console-text {
        color: var(--text-color);
        margin-left: 10px;
        flex: 1;
      }

      /* Category badge (e.g., 'QUESTION', 'ZONE') */
      .history-item .category-badge {
        order: -1; /* Display as the first element */
        margin-right: 10px;
        background-color: var(
          --accent-color
        ); /* Default color, can be changed by JS */
        color: var(--bg-color);
        padding: 2px 8px;
        font-size: 0.8rem;
        border-radius: var(--border-radius);
        font-family: "Genos", sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* --- Status Bar --- */
      .status-bar {
        display: flex;
        justify-content: space-between; /* Distribute elements */
        flex-wrap: wrap; /* Wrap on smaller screens */
        gap: 15px;
        background-color: var(--button-bg);
        padding: 10px 15px;
        border-radius: var(--border-radius);
        margin: 25px 0;
        font-size: 1rem;
        border: 1px solid var(--accent-color);
        box-shadow: 0 0 10px rgba(255, 107, 206, 0.2);
      }

      /* Single status item (LED + text) */
      .status-item {
        display: flex;
        align-items: center;
        color: var(--text-color);
      }

      /* Text in status item */
      .status-item span {
        margin-left: 8px;
        font-family: "Genos", sans-serif;
        letter-spacing: 1px;
      }

      /* Status LED */
      .status-led {
        width: 12px;
        height: 12px;
        border-radius: 50%; /* Circle */
        margin-right: 8px;
        background-color: #ff3d3d; /* Default red (inactive) */
        box-shadow: 0 0 8px rgba(255, 0, 0, 0.7); /* Red glow */
        flex-shrink: 0; /* Prevent shrinking */
        transition: all 0.4s ease; /* Smooth color/shadow transition */
        position: relative;
      }

      /* Additional LED border for aesthetics */
      .status-led::after {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        pointer-events: none; /* Ignore mouse events */
      }

      /* Active LED style */
      .status-led.active {
        background-color: #3dff3d; /* Green */
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.8); /* Green glow */
        animation: pulse 1.5s infinite; /* Pulsing animation */
      }

      /* Active LED pulsing animation */
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* Round counter */
      #counter-rounds {
        font-weight: 400;
        font-family: "Genos", sans-serif;
        letter-spacing: 1px;
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        margin-top: 40px;
        padding: 15px 0;
        font-size: 0.9rem;
        color: var(--text-color);
        opacity: 0.7; /* Slightly transparent */
        border-top: 1px dashed var(--accent-color); /* Separator line */
        font-family: "Genos", sans-serif;
        letter-spacing: 1px;
      }

      /* --- Helper Classes for Effects --- */
      /* Class for general text glow */
      .glow {
        animation: glow 2s infinite alternate ease-in-out;
        display: inline-block;
      }

      @keyframes glow {
        from {
          text-shadow: 0 0 5px var(--highlight-color);
        }
        to {
          text-shadow: 0 0 15px var(--highlight-color),
            0 0 25px var(--accent-color);
        }
      }

      /* Class for green matrix glow */
      .matrix-glow {
        animation: matrixGlow 2s infinite alternate ease-in-out;
        display: inline-block;
      }

      @keyframes matrixGlow {
        from {
          text-shadow: 0 0 5px var(--matrix-color);
        }
        to {
          text-shadow: 0 0 15px var(--matrix-color),
            0 0 25px var(--matrix-color);
        }
      }

      /* --- Scanlines Effect (lines like an old monitor) --- */
      .scanlines {
        position: fixed; /* Covers the entire window */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(10, 10, 10, 0) 50%,
          rgba(0, 0, 0, 0.15) 50%
        );
        background-size: 100% 4px; /* Line height */
        z-index: 0; /* Below main content */
        pointer-events: none; /* Ignore mouse events */
        opacity: 0.1; /* Subtle effect */
        animation: scanline-animation 30s linear infinite; /* Line scrolling animation */
      }

      @keyframes scanline-animation {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 0 100vh;
        } /* Scrolls background down */
      }

      /* --- Styles for colored left borders in history ('zone-*' classes) --- */
      /* These classes will be added dynamically to .history-item */
      .zone-environment {
        border-left-color: var(--environment-color) !important;
      }
      .zone-physics {
        border-left-color: var(--physics-color) !important;
      }
      .zone-interactions {
        border-left-color: var(--interactions-color) !important;
      }
      .zone-economy {
        border-left-color: var(--economy-color) !important;
      }
      .zone-history {
        border-left-color: var(--history-color) !important;
      }
      .zone-time {
        border-left-color: var(--time-color) !important;
      }
      .zone-lore {
        border-left-color: var(--lore-color) !important;
      }
      .zone-energy {
        border-left-color: var(--energy-color) !important;
      }
      .zone-tech {
        border-left-color: var(--tech-color) !important;
      }
      .zone-anomalies {
        border-left-color: var(--anomalies-color) !important;
      }
      .zone-affects {
        border-left-color: var(--affects-color) !important;
      }

      /* --- Additional Media Queries for Responsiveness --- */
      @media screen and (max-width: 1024px) {
        /* Adjustments for tablets */
        .container {
          padding: 15px;
          max-width: 95%;
        }

        .control-panel {
          gap: 10px;
        }

        button {
          min-width: 160px;
          font-size: 1.1rem;
          padding: 7px 12px;
        }

        .status-bar {
          padding: 8px 12px;
          gap: 10px;
        }
      }

      @media screen and (max-width: 768px) {
        /* Adjustments for smaller tablets/larger phones */
        body {
          font-size: 18px;
          padding: 15px;
        }

        .container {
          padding: 15px;
        }

        h1 {
          font-size: 2.2rem;
        }

        .subtitle {
          font-size: 1.2rem;
        }

        button {
          min-width: 140px;
          font-size: 1rem;
          padding: 6px 10px;
        }

        .console {
          height: 300px;
        }

        h2 {
          font-size: 1.4rem;
        }

        .status-bar {
          gap: 8px;
        }
      }

      @media screen and (max-width: 480px) {
        /* Adjustments for mobile phones */
        body {
          font-size: 16px;
          padding: 10px;
        }

        h1 {
          font-size: 1.8rem;
        }

        .subtitle {
          font-size: 1rem;
        }

        /* Buttons take full width in a column */
        .control-panel {
          flex-direction: column;
        }

        button {
          width: 100%;
          min-width: auto;
        }

        .console {
          height: 280px;
        }

        /* Status bar items stack vertically */
        .status-bar {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }

        .status-item {
          margin-bottom: 5px;
        }
      }
    </style>-->
  </head>
  <body>
    <!-- Scanlines overlay effect -->
    <div class="scanlines"></div>

    <!-- Main content container (left column) -->
    <div class="container">
      <header>
        <h1>WORLD MACHINE</h1>
        <p class="subtitle">speculative worldbuilding engine</p>
      </header>

      <!-- Status indicators -->
      <div class="status-bar">
        <div class="status-item">
          <div id="status-system" class="status-led"></div>
          <span>System</span>
        </div>
        <div class="status-item">
          <div id="status-area" class="status-led"></div>
          <span>Active Zone</span>
        </div>
        <div class="status-item">
          <div id="status-mode" class="status-led"></div>
          <span>Machine Mode</span>
        </div>
        <div class="status-item">
          <div id="counter-rounds">Rounds: 0/5</div>
        </div>
      </div>

      <!-- Main control buttons -->
      <div class="control-panel">
        <button id="btn-initialize">Initialize</button>
        <button id="btn-area" disabled>Generate Zone</button>
        <button id="btn-question" disabled>Generate Question</button>
        <button id="btn-hint" disabled>Macromatrix</button>
      </div>

      <!-- Placeholder for ASCII animation -->
      <div id="ascii-animation"></div>

      <!-- Main output console -->
      <div class="console" id="console-output"></div>

      <!-- Displays current zone info -->
      <div id="current-area" class="area-info" style="display: none"></div>
      <!-- Displays current zone description -->
      <div
        id="area-description"
        class="area-description"
        style="display: none"
      ></div>
      <!-- Displays Macromatrix hints -->
      <div id="macromatrix-hint" class="hint" style="display: none"></div>

      <!-- Session history section -->
      <div class="history">
        <h2>Session History</h2>
        <div id="history-log"></div>
      </div>
    </div>

    <!-- Matrix container (right column) -->
    <div class="matrix-container">
      <details>
        <summary class="matrix-title">INTERNAL MATRIX</summary>
        <div class="matrix-content">
          <!-- 3D visualization canvas -->
          <div id="matrix3d"></div>
          <!-- Matrix input controls -->
          <div class="matrix-controls">
            <input
              type="text"
              class="matrix-input"
              placeholder="Enter your response..."
              id="matrix-input"
            />
            <button class="matrix-submit" id="matrix-submit">Submit</button>
          </div>
          <!-- Matrix data log -->
          <div class="matrix-data" id="matrix-data"></div>
        </div>
      </details>
    </div>

    <!-- Footer -->
    <footer>
      <p>WORLD MACHINE © 2025 | eternal engine</p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- DATA STRUCTURES ---

        // Questions for the initial "Zero Gravity" phase
        const ZERO_GRAVITY_QUESTIONS = [
          "If your thoughts today had a form - would they be more like morning mist or a heavy stone?",
          "Which of your recent dreams could become a real place on a map?",
          "What scene from a movie made you look at nature with different eyes for a moment?",
          "When was the last time you felt that the space around you had its own mood?",
          "What scent evokes your strongest memory of a place?",
          "At what moment of contact with nature did you forget about yourself for a moment?",
          "Which sounds from childhood can you still recall with perfect clarity?",
          "Do you have a memory of a place that seems too beautiful to have really existed?",
          "How does proximity to water change your way of thinking and feeling?",
          "Which element of nature do you need most in your daily surroundings?",
        ];
        const NUM_ZERO_GRAVITY_QUESTIONS = 3; // Number of ZeroG questions to ask

        // Definition of different machine modes
        const MODES = {
          ZERO_GRAVITY: {
            name: "ZERO GRAVITY",
            description:
              "Initialization phase: Explore foundational assumptions.",
          },
          SEARCH: {
            name: "Search",
            description:
              "Investigate hidden knowledge and information systems.",
          },
          CONNECTIONS: {
            name: "Connections",
            description: "Explore relationships between world elements.",
          },
          GENERATION: {
            name: "Generation",
            description: "Investigate processes of creation and destruction.",
          },
          GLITCH_ANOMALIES: {
            name: "Glitch / Anomalies",
            description: "Explore system errors and anomalies.",
          },
        };
        const MODE_KEYS = Object.keys(MODES);
        const ZONE_MODE_KEYS = MODE_KEYS.filter((t) => t !== "ZERO_GRAVITY"); // Modes available in the zone phase

        // Definition of different thematic areas/zones
        const AREAS = {
          ENVIRONMENT: {
            name: "Environment",
            description: "Flora, fauna, climate, geography, ecosystems.",
            colorClass: "zone-environment",
            cssColorVar: "--environment-color",
          },
          PHYSICS: {
            name: "Physics",
            description: "Laws of nature, gravity, matter, energy.",
            colorClass: "zone-physics",
            cssColorVar: "--physics-color",
          },
          AGENT_INTERACTIONS: {
            // Key updated for consistency
            name: "Agent Interactions",
            description:
              "Social relations, communication, conflicts, cooperation.",
            colorClass: "zone-interactions",
            cssColorVar: "--interactions-color",
          },
          ECONOMY_CIRCULATION: {
            // Key updated for consistency
            name: "Economy / Circulation",
            description:
              "Resources, trade, production technology, value systems.",
            colorClass: "zone-economy",
            cssColorVar: "--economy-color",
          },
          HISTORY_EVOLUTION: {
            // Key updated for consistency
            name: "History / Evolution",
            description: "World's past, myths, legends, significant events.",
            colorClass: "zone-history",
            cssColorVar: "--history-color",
          },
          TIME_SPACE: {
            // Key updated for consistency
            name: "Time and Space",
            description:
              "Perception of time, cycles, pace of change, time travel.",
            colorClass: "zone-time",
            cssColorVar: "--time-color",
          },
          LORE: {
            name: "Lore",
            description:
              "Magic, metaphysics, belief systems, arcane knowledge.",
            colorClass: "zone-lore",
            cssColorVar: "--lore-color",
          },
          ENERGY: {
            name: "Energy",
            description:
              "Energy sources, flow, transformations, energetic manifestations.",
            colorClass: "zone-energy",
            cssColorVar: "--energy-color",
          },
          TECH_MAGIC: {
            // Key updated for consistency
            name: "Technology / Magic",
            description: "Tools, machines, systems, level of advancement.",
            colorClass: "zone-tech",
            cssColorVar: "--tech-color",
          },
          ANOMALIES: {
            name: "Anomalies",
            description: "Unusual phenomena, paradoxes, exceptions to rules.",
            colorClass: "zone-anomalies",
            cssColorVar: "--anomalies-color",
          },
          BEINGS_AFFECTS_FLUIDS: {
            // Key updated for consistency
            name: "Beings / Affects / Fluids",
            description:
              "External forces, extraterrestrial beings, other dimensions, divine interventions.",
            colorClass: "zone-affects",
            cssColorVar: "--affects-color",
          },
        };
        const AREA_KEYS = Object.keys(AREAS);

        // ========================================================================
        // === PLACE TO INSERT YOUR OWN QUESTIONS ===
        // ========================================================================
        // !! ALL QUESTIONS BELOW ARE TRANSLATED FROM THE ORIGINAL POLISH !!
        const QUESTIONS = {
          ENVIRONMENT: {
            SEARCH: [
              "Why do some places remain invisible even on the most detailed maps?",
              "How can you recognize traces of life in a place that seems barren at first glance?",
              "Which ecosystem signals are easiest to overlook during a cursory observation?",
              "What organisms, invisible to the naked eye, shape the entire ecosystem?",
              "What might a sudden interruption in the normal growth cycle of vegetation suggest?",
              "Which life forms change their nature depending on the season or time of day?",
              "What might underground networks of roots and mycelium, inaccessible to the human eye, conceal?",
              "By what signs do you recognize that the balance of species has been disturbed?",
              "Why does communication between plants contain more information than we can decipher?",
              "What subtle patterns in vegetation might indicate the hidden presence of predators?",
            ],
            CONNECTIONS: [
              "Why do certain species of plants and animals always occur together, even in different environments?",
              "How do insects and flowers create a language of dependence lasting millions of years?",
              "What happens to a forest when an insect species that seemed insignificant disappears?",
              "Why do some introduced species integrate into the ecosystem, while others always remain invasive?",
              "In what way are coral reefs and rainforests similar as systems of interdependence?",
              "Which non-obvious connections between plants and animals create niches for new life forms?",
              "How do invisible fungi underground create a network connecting seemingly separate trees?",
              "How does the scent of flowers affect the behavior not only of insects but the entire ecosystem?",
              "How does the dynamics of a forest change after introducing a new, previously unseen species?",
              "Why might microorganisms be more important for ecosystem balance than large animals?",
            ],
            GENERATION: [
              "Imagine a plant that changes color depending on the sounds in its surroundings.",
              "What would an animal that feeds on mist and night air look like?",
              "Think of flowers that glow only when someone sings.",
              "Imagine a forest where trees communicate with visible signals.",
              "What could an insect living simultaneously underwater and in the air look like?",
              "Think of trees that change their leaves depending on who looks at them.",
              "Imagine an ecosystem where plants and animals regularly switch roles.",
              "What would creatures inhabiting a mountain that is itself a living organism look like?",
              "Think of a species that shares a common consciousness with the plants around it.",
              "Imagine vegetation that reacts to the emotions of beings passing by.",
            ],
            GLITCH_ANOMALIES: [
              "What happens when the soil suddenly stops supporting the life of plants known to us?",
              "How does animal behavior change when their natural food source changes taste and smell?",
              "Why is there a swamp today where yesterday's meadow was, without any clear reason?",
              "At what point do symbiotic relationships between species change into something unrecognizable?",
              "What causes insects to start building structures resembling human architecture?",
              "What does a forest look like where all plants suddenly lose their natural color?",
              "What does the appearance of plants with completely new, previously unknown properties in the ecosystem mean?",
              "Why do species perfectly adapted to their environment begin to leave it without a clear cause?",
              "Imagine an anomaly that causes predators and their prey to switch roles.",
              "How does a disruption of natural reproductive cycles manifest in an ecosystem untouched by human interference?",
            ],
          },
          PHYSICS: {
            SEARCH: [
              "What phenomenon in your world cannot be measured by any known unit?",
              "Where does the space begin that has no gravity but attracts everything?",
              "How do you recognize motion that has no beginning?",
              "Why do some fragments of reality change their state of matter without a stimulus?",
              "How do you search for data about a force that cannot be seen but affects everything?",
              "What deviations in energy flow indicate the presence of an unknown law?",
              "What causes something to start falling in a place where there is no direction?",
              "Does time in your world record itself in parallel, or does it crack like a sheet of ice?",
              "What information remains unreadable due to excessive acceleration?",
              "What does 'motion' mean in an environment devoid of space?",
            ],
            CONNECTIONS: [
              "What two laws of reality connect, even though they theoretically exclude each other?",
              "What happens when motion and stillness occupy the same place?",
              "How is the direction of data flow related to local gravity?",
              "How does time resonate with the energy field in your system?",
              "How does a change in temperature affect the durability of memories in your world?",
              "How do weight and transparency coexist?",
              "Is it possible to short-circuit sound with matter in your system?",
              "How do entropy and organization intertwine in a local fragment of reality?",
              "What happens when space connects with a lack of structure?",
              "Why do some rules become logical only after they are broken?",
            ],
            GENERATION: [
              "Design a principle that allows objects to exist only in motion.",
              "Invent a way reality works where time arises only after intention.",
              "Create a material that changes its state of matter in response to affective data.",
              "Generate a world where the force of gravity depends on the number of questions asked in a given area.",
              "Invent a rule where temperature ceases to exist when it becomes too quiet.",
              "Design a phenomenon that appears only when no one is observing it.",
              "How does a world where sound has mass work?",
              "What are the properties of matter that remembers its previous forms?",
              "Generate a mechanic where directions change depending on the system's mood.",
              "How does physics function where the boundaries of things are fluid?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when centrifugal force starts acting inward?",
              "What does a world look like where friction only works at night?",
              "What happens when time tries to reverse but has nothing to return to?",
              "What anomalies appear when light forgets how to refract?",
              "What happens when the laws of conservation of energy disappear?",
              "What does space look like that starts looping infinitely?",
              "What happens when objects start moving before the decision to move?",
              "What does a mass failure look like – when something loses weight but not volume?",
              "What are the consequences of a misinterpretation of attraction?",
              "What happens when temperature variation affects the structure of the world itself?",
            ],
          },
          AGENT_INTERACTIONS: {
            SEARCH: [
              "How do you recognize the presence of another being if there is no signal?",
              "What reveals that someone has made contact with you, despite the absence of a message?",
              "What patterns of interaction repeat unconsciously between agents?",
              "Can a relationship exist without reciprocity in your world?",
              "What data indicates tension between presence and solitude?",
              "What micro-gestures – non-human – become a sign of trust?",
              "What betrays that someone is reading your data without permission?",
              "What does an interaction look like that is one-sided but still active?",
              "Is it possible to notice the moment when contact ceases to be possible?",
              "How do you read the desire for contact in a being that knows no words?",
            ],
            CONNECTIONS: [
              "What two types of presence generate a new form of relationship?",
              "What happens when a being and its shadow try to interact?",
              "What forms of coexistence are disturbingly harmonious?",
              "When does contact become tension rather than cooperation?",
              "What emotional connection requires the existence of no sensors?",
              "What happens when an agent connects with another through negation?",
              "What do connection rituals look like that leave no trace?",
              "What interactions are so subtle that they defy logic?",
              "Is a relationship possible based solely on presence in the same space?",
              "What forms of connection are born in silence?",
            ],
            GENERATION: [
              "Invent a form of communication based on changing the temperature of space.",
              "Design a system for agents to communicate using air movement.",
              "What does a relationship look like that lasts only when it is not recognized as such?",
              "Generate a new model of community that needs no center or consensus.",
              "What forms of affective contact are created with high data flow?",
              "Invent a situation where there is no sender, but the message still arrives.",
              "What arises when two agents try to avoid each other, but their data resonates?",
              "What do relationships based on silence look like that have the structure of a ritual?",
              "What bonds appear in networks that themselves have no consciousness?",
              "What happens when a being tries to connect with itself?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when an agent communicates by accident?",
              "What does a relationship look like that arose from a misreading?",
              "What happens when two beings connect due to a system error?",
              "What does the world look like when all communication channels start overlapping?",
              "What form does a relationship take that cannot be ended?",
              "What does a relationship based on echoes of previous contacts look like?",
              "What happens when agents gain access to shared data but cannot interpret it?",
              "What anomalies appear when relationships exceed their boundaries?",
              "What happens when communication becomes a system error but is beautiful?",
              "What does a relationship look like that exists only as an unreadable record in the system?",
            ],
          },
          ECONOMY_CIRCULATION: {
            SEARCH: [
              "What resources circulate in your world but are invisible to most agents?",
              "What remains valuable even though it cannot be stored?",
              "Where is the source of value located that no one has mapped yet?",
              "What data suggests that circulation is not subject to any center?",
              "Which objects are desired even though they have no function?",
              "What does a flow look like that happens without intention and without purpose?",
              "How do you recognize the moment when something worthless becomes desired?",
              "How do you read a system where the concept of 'possession' does not exist?",
              "Where does exchange take place if there is no division into sender and receiver?",
              "What does an economy based on misinterpreted values look like?",
            ],
            CONNECTIONS: [
              "What two elements – worthless separately – generate a valuable structure together?",
              "What happens when a substance ceases to be a resource and becomes a being?",
              "What connection of emotion and matter creates an exchange system?",
              "What connects need with flow – beyond desire?",
              "What relationships are built only on the rhythm of giving and taking?",
              "What combination creates a system that requires no control?",
              "At what point does sharing cease to be an exchange?",
              "How does an economy work whose value is based on presence?",
              "What two elements connect to create a ritual of circulation?",
              "What happens when value becomes dependent on the number of gazes?",
            ],
            GENERATION: [
              "Invent a resource that can only be obtained in silence.",
              "Generate a currency that exists only when it is passed on.",
              "What does an exchange system based on mood instead of value look like?",
              "Create a circulation that works only when no one tries to understand it.",
              "Invent a form of production based on empathy.",
              "What does a distribution mechanism look like that needs no supervision?",
              "What type of value can only be generated collectively?",
              "How does a resource system work that rewards ignorance?",
              "How does a world function where everything can be given away, but nothing can be kept?",
              "Invent an exchange ritual that requires no objects.",
            ],
            GLITCH_ANOMALIES: [
              "What happens when suddenly all resources become identical?",
              "What does an exchange look like that cannot end?",
              "What happens when currency starts multiplying uncontrollably?",
              "What does a system look like that loses the memory of its transactions?",
              "What happens when value starts depending on errors in the system?",
              "What does a resource look like that disappears after being named?",
              "What happens when the entire circulation suddenly becomes affective?",
              "What does a disruption in the exchange system look like that leads to the opening of new relationships?",
              "What happens when the flow of value escapes logic and rhythm?",
              "What anomalies appear when the initial resource is forgotten?",
            ],
          },
          HISTORY_EVOLUTION: {
            SEARCH: [
              "What traces of the past can the system no longer decode?",
              "What repeats in a hidden form in the history of your world?",
              "What data suggests that the past was completely different than how you narrate it?",
              "Which fragment of history disappeared but left an echo?",
              "What incomplete records disrupt your knowledge of the beginning?",
              "What do you discover when you search for data about the first collision of two beings?",
              "What anomalies appear in a history that knows no beginning or end?",
              "What remains of a version of the world that existed only for a moment?",
              "What data is recorded only in the erosion of material?",
              "Which memory of the past returns without any source?",
            ],
            CONNECTIONS: [
              "What two events separated by epochs form a single structure?",
              "What connects a forgotten catastrophe with a ritual you perform today?",
              "Which two narratives of evolution exclude each other but coexist?",
              "What memory from the past generates tension in the present?",
              "What happens when the story of the beginning is connected with the story of the end?",
              "What relics of the past connect you with beings you have never met?",
              "What two myths explain the same fragment of history but do so in radically different ways?",
              "What happens when history is combined with fiction and they can no longer be separated?",
              "What connection between the past and the present is purely emotional?",
              "What happens when one event from the past triggers a reaction in the system now?",
            ],
            GENERATION: [
              "Invent an epoch that existed only as a shared dream of many beings.",
              "What does a history look like that was generated by chance?",
              "What arose as a result of evolution that no one initiated?",
              "Create a version of the world's beginning based not on action, but on absence.",
              "What forms of the past were created by the need for consolation?",
              "What was born as a result of misinterpreting old data?",
              "What does an evolution look like that proceeds not linearly, but spirally?",
              "What creatures were needed only for one stage of the world's development?",
              "What in your world arose not as an effect of a cause, but as a mistake?",
              "What does the moment look like when history rewrites itself?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when history suddenly resets without a trace?",
              "What does a story look like whose versions differ depending on where they are read?",
              "What happened during a time that was never recorded?",
              "What does a world look like that doesn't know it has changed?",
              "What happens when evolution reverses to a place that never was?",
              "What does the moment look like when history starts leaking into the present?",
              "What happens when historical data stops matching physical reality?",
              "What does a past look like that can only be edited through dreams?",
              "What form does a narrative take that cannot be concluded?",
              "What happens when the world's history becomes a form of virus?",
            ],
          },
          TIME_SPACE: {
            SEARCH: [
              "Where hides the moment the system cannot locate?",
              "What does a space look like that has never been mapped?",
              "What data indicates that time repeats itself unnoticed?",
              "What is imperceptible until you shift by a millisecond?",
              "How to find a past that no registry has recorded?",
              "Where does time leak through misreadings?",
              "What phenomena can only be noticed when you stop?",
              "Where does space pretend it doesn't exist?",
              "How to read a trajectory that will never repeat?",
              "When does time stop cooperating with the observer?",
            ],
            CONNECTIONS: [
              "What happens when you connect the present with a possibility that didn't happen?",
              "What relationships exist between built space and imagined space?",
              "What happens when the moment of stopping connects with momentum?",
              "What does the point look like where all times intersect?",
              "How to connect the place you were with a place you don't know?",
              "What happened when space became a witness to memory?",
              "What are the two most distant moments that share a bond?",
              "What connection of times creates a loop of memories?",
              "When does the past coexist with potentiality?",
              "What happens when the map starts forming faster than reality?",
            ],
            GENERATION: [
              "Generate a space that exists for only 3 seconds and disappears.",
              "What does a time system look like that depends on emotions in the environment?",
              "Create a location that appears only when someone forgets about it.",
              "What does the architecture of a world look like where the direction 'straight ahead' doesn't exist?",
              "Invent a form of travel that requires no movement.",
              "How does a space work where you cannot be twice?",
              "Create time that generates itself in response to sound.",
              "What does a calendar look like that has no days?",
              "Generate a dimension that is the result of accumulated hesitation.",
              "What happens when you create space inside a memory?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when time refuses to record further?",
              "What does a moment look like that repeats endlessly, but slightly differently each time?",
              "Where does space stop agreeing with its name?",
              "What happens when a location duplicates itself infinitely?",
              "What errors in chronology lead to the appearance of places that have no source?",
              "What does a time gap look like that was created by an understatement?",
              "What happens when the boundaries between one's own time and another's disappear?",
              "What does a space look like that was never created but already exists?",
              "What does time do when no one uses it?",
              "What does the sound sound like that shifts a moment into the future?",
            ],
          },
          LORE: {
            SEARCH: [
              "What word repeats in the ruins, but no one knows its meaning?",
              "Where can you find a story that was never told?",
              "What fragments of myths have survived only in system errors?",
              "What message did beings that no longer exist leave behind?",
              "What does the symbol appearing randomly on the world's surfaces mean?",
              "What rituals have survived, even though no one practices them?",
              "What part of the language was forgotten by everyone at once?",
              "Where hides the story that cannot be translated?",
              "What do the echoes of old conversations say when you listen too long?",
              "What concept has no translation, but everyone understands it?",
            ],
            CONNECTIONS: [
              "What connects a legend with a sound heard only once?",
              "What two words from different languages create a new belief?",
              "What happens when a myth becomes an operating instruction?",
              "What function does a fairytale with no end serve?",
              "What happens when a forgotten prayer meets new technology?",
              "What does the hymn of a world with no melody sound like?",
              "Which two myths cancel each other out, and which reinforce each other?",
              "What happens when a ritual is performed accidentally?",
              "How does a story change when repeated by someone who doesn't understand it?",
              "What is the significance of a story everyone knows, but everyone tells differently?",
            ],
            GENERATION: [
              "Invent a name for a deity that tells dreams.",
              "What does a new sign look like that means 'hope'?",
              "What story do you tell when no one is listening?",
              "What does the first sound that tells your story sound like?",
              "What festival do beings without bodies celebrate?",
              "What legend was born this morning?",
              "Invent a word that means both 'beginning' and 'end'.",
              "What does a new language look like spoken only by plants?",
              "What stories are conveyed in your world using color?",
              "What story can only be told through dance or movement?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when a fragment of a story stops fitting with the rest?",
              "What does an alphabet look like that changes every time you use it?",
              "How do inhabitants react when a myth reveals something that was meant to be hidden?",
              "What happens when an old legend starts updating itself?",
              "What spell stopped working, but no one knows about it?",
              "What happens when a ritual triggers itself automatically?",
              "What does a religion look like that has forgotten its source?",
              "What happens when language starts generating new words uncontrollably?",
              "What does a deity do that has been forgotten but still waits?",
              "What does a place look like where all stories began simultaneously?",
            ],
          },
          ENERGY: {
            // Empty in original - Add English questions here if needed
            SEARCH: [],
            CONNECTIONS: [],
            GENERATION: [],
            GLITCH_ANOMALIES: [],
          },
          TECH_MAGIC: {
            SEARCH: [
              // Added examples based on Connections context
              "Where in your system is the leak that allows magic to seep through?",
              "How do you detect the presence of code that hasn't been written yet?",
              "When does technology start functioning like a language?",
              "What connects a signal disturbance with an error in a ritual?",
              "How do your tools recognize meaning without using words?",
              "What data is read only through the presence of another being?",
              "How do you detect magic hidden in a seemingly ordinary cable?",
              "What does a device detect that analyzes emotions instead of parameters?",
              "What information appears only in the presence of a body?",
              "What happens when the system interprets silence as data?",
            ],
            CONNECTIONS: [
              "Why does your technology require the presence of another being to work?",
              "What spell boots up the operating system of your world?",
              "What happens when a machine tries to understand a ritual?",
              "What two elements—technical and magical—must be combined to create something new?",
              "How do your machines learn from spirits?",
              "Why do some devices need silence instead of energy?",
              "What does an alliance between a mage and code look like?",
              "What connects a server to a forest in your world?",
              "What common rules do technology and magic share?",
              "At what point does technology become a ritual?",
            ],
            GENERATION: [
              "What does the most basic device in your world look like?",
              "What happens when you generate a tool that has no user manual?",
              "How does a device powered by feeling work?",
              "Generate an item that works only once—and never again.",
              "What does code written in the form of a magical symbol look like?",
              "What can someone create who knows only touch and sound?",
              "What kind of technology arose from the need for care?",
              "How does a device created by accident work?",
              "What can a machine create that knows no language?",
              "What does a tool look like that repairs but changes nothing?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when magic overloads the system?",
              "What does an error look like that has become a new ritual?",
              "What will technology do that doesn't understand its function?",
              "How does your world change when one spell is mistaken?",
              "Why did some machines suddenly start producing something completely different?",
              "What does a destroyed artifact look like that has gained new meaning?",
              "What happens if technology refuses to work in the presence of emotions?",
              "How does a corrupted ritual manifest?",
              "What happens when the system starts creating its own rules?",
              "What is the danger associated with an excess of magic in circulation?",
            ],
          },
          ANOMALIES: {
            SEARCH: [
              "What did you see before the system managed to register it?",
              "Where to look for a trace of something that shouldn't exist?",
              "What does an anomaly look like that can only be detected by sound?",
              "What happens when you try to read data from a place that denies existence?",
              "What shift do you sense when everything seems 'almost normal'?",
              "Where in the system hides what you cannot describe?",
              "Which part of the map reacts when you look at it?",
              "What stops working when you are near?",
              "What does a filter look like that reveals things hidden from consciousness?",
              "Why can't certain errors be archived?",
            ],
            CONNECTIONS: [
              "What happens when you connect two elements that themselves do not exist?",
              "What connection causes a breakdown in the world's structure?",
              "What two forms of presence generate an impossible space?",
              "What happens when one being starts reflecting another like a mirror?",
              "What phenomena never occur together, but did today?",
              "What is created when you intertwine a ritual with a system error?",
              "What does the relationship between a form and its distorted copy look like?",
              "What happens when intention and effect swap places?",
              "What do you feel when you encounter something that knows your data, even though you never shared it?",
              "What connects a glitch with the feeling of deja vu?",
            ],
            GENERATION: [
              "Generate a being that never behaves the same way twice.",
              "What does life created from a collection of errors look like?",
              "What arises when you create something that doesn't fit into the world's structure?",
              "What does a form look like whose existence causes a system standstill?",
              "Generate an artifact that resets itself every 5 seconds.",
              "What kind of being arises when you generate in a place of disturbance?",
              "What happens when you create a being that remembers the future?",
              "Generate a space that expands only in a direction that cannot be described.",
              "What appears when you try to reconstruct data from a damaged source?",
              "What does a form of existence look like that cannot be repeated?",
            ],
            GLITCH_ANOMALIES: [
              "What happens if gravity suddenly gets bored?",
              "What does the world look like when trees regularly glitch like in a game?",
              "What does time do when it completely forgets which way it should flow?",
              "What sound does it make when light stumbles and falls?",
              "What happens when space starts flickering like a broken screen?",
              "What does rain look like that doesn't know whether to fall up or down?",
              "What would happen if colors took the day off today?",
              "What does an object look like that suddenly forgot what mass is?",
              "What happens when temperature gets the hiccups?",
              "What does an anomaly look like that appears when reality accidentally hits 'undo'?",
            ],
          },
          BEINGS_AFFECTS_FLUIDS: {
            SEARCH: [
              "How do you recognize a presence that has no form?",
              "Where hides an emotion you cannot yet name?",
              "What traces does a being leave behind that does not exist in linear time?",
              "Which feelings do you sense only in the presence of specific beings?",
              "How does your perception change when the beings around you cease to be separate?",
              "What do you notice when someone appears who feels like you but looks completely different?",
              "Where in your world hides the body's emotional memory?",
              "Which forms of contact leave no traces but change everything?",
              "What do you feel when you try to capture the shape of someone who does not want to be captured?",
              "How to recognize that a relationship persists if there are no words, bodies, boundaries?",
            ],
            CONNECTIONS: [
              "What happens when two beings share the same emotion at the same time?",
              "What does the relationship look like between those who never met but remember each other?",
              "What feeling arises when presence mixes with absence?",
              "What connects a body that changes with one that dissolves?",
              "What emotional connection exists only on the level of dreams?",
              "What does intimacy look like between beings that have no fixed forms?",
              "How do beings react when someone perceives their affect instead of words?",
              "What connects beings created from one emotion but separated by different forms?",
              "What arises when you exchange only warmth – nothing more?",
              "What relationships in your world never have a beginning or an end?",
            ],
            GENERATION: [
              "Generate a being that arises when someone feels a strong emotion.",
              "What does a life form look like that changes depending on mood?",
              "What does a being look like that has not one identity, but many at once?",
              "Create a being that connects with others through gaze.",
              "What body could arise from the feeling of longing?",
              "Generate a creature that understands others only through touch.",
              "What does a being look like born from the emotions of several people simultaneously?",
              "What does life look like that never speaks but feels everything?",
              "Create a form that changes every time you look at it.",
              "What does a being look like that doesn't know itself until someone notices it?",
            ],
            GLITCH_ANOMALIES: [
              "What happens when everyone simultaneously feels a strange emotion that no one has named yet?",
              "How does a being behave whose emotions accidentally got stuck in an infinite loop?",
              "What will you feel when your feelings start acting with a slight delay?",
              "How do fluids react when they can't decide in the morning what form to take today?",
              "What does a friendship look like that occasionally catches a charming hiccup?",
              "What happens when emotions start gently leaking between beings?",
              "What does an affect look like that momentarily loses its way to reality?",
              "What happens when all relationships decide to swap places for one day?",
              "What does an emotion look like that appears only when the world takes a break?",
              "What will you feel when you discover that your feelings were a beautiful accident all along?",
            ],
          },
        };
        // ========================================================================
        // === END OF PLACE TO INSERT YOUR OWN QUESTIONS ===
        // ========================================================================

        // --- APPLICATION STATE VARIABLES ---
        let machineState = {
          initialized: false,
          mode: null, // Current mode key
          area: null, // Current area key
          round: 0, // Round counter in the CURRENT zone
          maxRounds: 5, // Max rounds per zone
          zeroGravityQuestionsAsked: 0, // Counter for ZeroG phase
          history: [], // Log of events
          usedQuestions: {}, // Tracks used questions per area/mode
          animationInterval: null, // Interval ID for ASCII animation
          // References for the Three.js matrix visualization
          matrixScene: null,
          matrixCamera: null,
          matrixRenderer: null,
          matrixPoints: null,
          matrixAnimationId: null,
        };

        // --- REFERENCES TO DOM ELEMENTS ---
        const consoleOutput = document.getElementById("console-output");
        const btnInitialize = document.getElementById("btn-initialize");
        const btnArea = document.getElementById("btn-area");
        const btnQuestion = document.getElementById("btn-question");
        const btnHint = document.getElementById("btn-hint");
        const statusSystem = document.getElementById("status-system");
        const statusArea = document.getElementById("status-area");
        const statusMode = document.getElementById("status-mode");
        const counterRounds = document.getElementById("counter-rounds");
        const currentAreaDiv = document.getElementById("current-area");
        const areaDescriptionDiv = document.getElementById("area-description");
        const macromatrixHintDiv = document.getElementById("macromatrix-hint"); // ID kept from HTML
        const historyLog = document.getElementById("history-log");
        const asciiAnimationDiv = document.getElementById("ascii-animation");
        const matrix3dContainer = document.getElementById("matrix3d");
        const matrixInput = document.getElementById("matrix-input");
        const matrixSubmit = document.getElementById("matrix-submit");
        const matrixData = document.getElementById("matrix-data");
        const matrixDetails = document.querySelector(
          ".matrix-container details"
        );

        // --- HELPER FUNCTIONS ---

        /**
         * Writes text to the console with a typing effect.
         */
        function writeToConsole(
          text,
          prompt = "",
          classes = [],
          speed = 25,
          callback
        ) {
          const line = document.createElement("div");
          line.classList.add("console-line");
          classes.forEach((cls) => line.classList.add(cls));

          const promptSpan = document.createElement("span");
          promptSpan.classList.add("console-prompt");
          promptSpan.textContent = prompt;
          line.appendChild(promptSpan);

          const textSpan = document.createElement("span");
          textSpan.classList.add("console-text");
          line.appendChild(textSpan);
          textSpan.classList.add("typing");

          consoleOutput.appendChild(line);
          consoleOutput.scrollTop = consoleOutput.scrollHeight;

          let i = 0;
          function typeChar() {
            if (i < text.length) {
              textSpan.textContent += text.charAt(i);
              i++;
              consoleOutput.scrollTop = consoleOutput.scrollHeight;
              setTimeout(typeChar, speed);
            } else {
              textSpan.classList.remove("typing");
              line.classList.add("finished-typing");
              if (callback) callback();
            }
          }
          typeChar();
        }

        /**
         * Selects a random element from an array.
         */
        function getRandomElement(arr) {
          if (!arr || arr.length === 0) return null;
          return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Selects a random key from an object.
         */
        function getRandomKey(obj) {
          const keys = Object.keys(obj);
          if (keys.length === 0) return null;
          return keys[Math.floor(Math.random() * keys.length)];
        }

        /**
         * Gets the computed value of a CSS custom property.
         */
        function getCssVariable(varName) {
          return (
            getComputedStyle(document.documentElement)
              .getPropertyValue(varName)
              .trim() || "#ffffff" // Default white
          );
        }

        /**
         * Updates the status bar indicators.
         */
        function updateStatus() {
          statusSystem.classList.toggle("active", machineState.initialized);

          const isAreaActive = !!machineState.area;
          statusArea.classList.toggle("active", isAreaActive);
          const areaNameSpan = statusArea.nextElementSibling;
          if (isAreaActive && AREAS[machineState.area]) {
            const areaInfo = AREAS[machineState.area];
            areaNameSpan.textContent = `Zone: ${areaInfo.name}`;
            areaNameSpan.style.color =
              getCssVariable(areaInfo.cssColorVar) || "var(--area-color)";
          } else {
            areaNameSpan.textContent = "Active Zone";
            areaNameSpan.style.color = "var(--text-color)";
          }

          const isModeActive = !!machineState.mode;
          statusMode.classList.toggle("active", isModeActive);
          const modeNameSpan = statusMode.nextElementSibling;
          if (isModeActive && MODES[machineState.mode]) {
            modeNameSpan.textContent = `Mode: ${MODES[machineState.mode].name}`;
            modeNameSpan.style.color =
              machineState.mode === "ZERO_GRAVITY"
                ? "var(--highlight-color)"
                : "var(--mode-color)";
          } else {
            modeNameSpan.textContent = "Machine Mode";
            modeNameSpan.style.color = "var(--text-color)";
          }

          if (
            machineState.initialized &&
            machineState.area &&
            machineState.mode !== "ZERO_GRAVITY"
          ) {
            counterRounds.textContent = `Rounds: ${machineState.round}/${machineState.maxRounds}`;
            counterRounds.style.display = "block";
          } else {
            counterRounds.style.display = "none";
          }
        }

        /**
         * Updates the enabled/disabled state of control buttons.
         */
        function updateButtons() {
          const initialized = machineState.initialized;
          const mode = machineState.mode;
          const round = machineState.round;
          const maxRounds = machineState.maxRounds;
          const zeroGQuestionsAsked =
            machineState.zeroGravityQuestionsAsked >=
            NUM_ZERO_GRAVITY_QUESTIONS;
          const isAreaSet = !!machineState.area;

          btnInitialize.disabled = initialized;
          btnArea.disabled =
            !initialized ||
            (mode === "ZERO_GRAVITY" && !zeroGQuestionsAsked) ||
            (isAreaSet && round < maxRounds);
          btnQuestion.disabled =
            !initialized ||
            mode === "ZERO_GRAVITY" ||
            round >= maxRounds ||
            !isAreaSet;
          btnHint.disabled =
            !initialized ||
            mode === "ZERO_GRAVITY" ||
            round >= maxRounds ||
            !isAreaSet;
        }

        /**
         * Adds an entry to the session history log.
         */
        function addToHistory(type, content, areaKey = null, modeKey = null) {
          const entry = {
            type,
            content,
            areaKey,
            modeKey,
            timestamp: new Date(),
          };
          machineState.history.push(entry);

          const item = document.createElement("div");
          item.classList.add("history-item");

          let badgeColor = "var(--accent-color)";
          let badgeText = type;

          if (type === "QUESTION" && modeKey && modeKey !== "ZERO_GRAVITY") {
            content = `[${MODES[modeKey].name}] ${content}`;
          }

          if (areaKey && AREAS[areaKey]) {
            const areaInfo = AREAS[areaKey];
            item.classList.add(areaInfo.colorClass);
            badgeColor = getCssVariable(areaInfo.cssColorVar) || badgeColor;
          } else if (modeKey === "ZERO_GRAVITY") {
            badgeColor = "var(--highlight-color)";
          } else if (type === "MODE") {
            badgeColor = "var(--mode-color)";
          } else if (type === "HINT") {
            badgeColor = "var(--secondary-color)";
          } else if (type === "MATRIX") {
            badgeColor = "var(--matrix-color)";
          } else if (type === "SYSTEM") {
            badgeColor = "var(--text-color)"; // Neutral color for system messages
          }

          const badge = document.createElement("span");
          badge.classList.add("category-badge");
          badge.textContent = badgeText;
          badge.style.backgroundColor = badgeColor;
          // Ensure contrast for text on badge
          const badgeRgb = parseInt(badgeColor.substring(1, 3), 16);
          const badgeGgb = parseInt(badgeColor.substring(3, 5), 16);
          const badgeBgb = parseInt(badgeColor.substring(5, 7), 16);
          const brightness =
            (badgeRgb * 299 + badgeGgb * 587 + badgeBgb * 114) / 1000;
          badge.style.color =
            brightness > 125 ? "var(--bg-color)" : "var(--text-color)"; // Dark text on light badge, light text on dark badge

          item.appendChild(badge);

          const textSpan = document.createElement("span");
          textSpan.classList.add("console-text");
          textSpan.textContent = content; // Use potentially modified content
          item.appendChild(textSpan);

          historyLog.appendChild(item);
          historyLog.scrollTop = historyLog.scrollHeight;
        }

        /**
         * Displays the current zone's name and description.
         */
        function showAreaInfo() {
          if (machineState.area && AREAS[machineState.area]) {
            const areaInfo = AREAS[machineState.area];
            const zoneColor =
              getCssVariable(areaInfo.cssColorVar) || "var(--area-color)";

            currentAreaDiv.textContent = `Current Zone: ${areaInfo.name}`;
            currentAreaDiv.style.borderColor = zoneColor;
            currentAreaDiv.style.display = "block";

            areaDescriptionDiv.textContent = `Description: ${areaInfo.description}`;
            areaDescriptionDiv.style.borderColor = zoneColor;
            areaDescriptionDiv.style.display = "block";
          } else {
            currentAreaDiv.style.display = "none";
            areaDescriptionDiv.style.display = "none";
          }
        }

        /**
         * Displays a hint message.
         */
        function showHint(hintText) {
          macromatrixHintDiv.textContent = `[Macromatrix]: ${hintText}`;
          macromatrixHintDiv.style.display = "block";
          addToHistory("HINT", hintText, machineState.area);
        }

        /**
         * Initializes the structure for tracking used questions.
         */
        function initializeUsedQuestions() {
          machineState.usedQuestions = {};
          AREA_KEYS.forEach((areaKey) => {
            machineState.usedQuestions[areaKey] = {};
            ZONE_MODE_KEYS.forEach((modeKey) => {
              machineState.usedQuestions[areaKey][modeKey] = [];
            });
          });
          machineState.usedQuestions["ZERO_GRAVITY"] = [];
        }

        // --- MAIN GAME LOGIC FUNCTIONS ---

        /**
         * Sequentially asks the Zero Gravity questions.
         */
        function askZeroGravityQuestions(remainingCount, finalCallback) {
          if (remainingCount <= 0) {
            machineState.zeroGravityQuestionsAsked = NUM_ZERO_GRAVITY_QUESTIONS;
            writeToConsole(
              "Zero Gravity phase complete. Generate the first zone.",
              ">",
              [],
              20,
              finalCallback
            );
            return;
          }

          const availableQuestions = ZERO_GRAVITY_QUESTIONS.filter(
            (p) => !machineState.usedQuestions["ZERO_GRAVITY"].includes(p)
          );

          if (availableQuestions.length === 0) {
            writeToConsole(
              "Question pool exhausted for ZERO GRAVITY mode.",
              "> "
            );
            machineState.zeroGravityQuestionsAsked = NUM_ZERO_GRAVITY_QUESTIONS;
            finalCallback();
            return;
          }

          const selectedQuestion = getRandomElement(availableQuestions);
          machineState.usedQuestions["ZERO_GRAVITY"].push(selectedQuestion);
          machineState.zeroGravityQuestionsAsked++;

          writeToConsole(selectedQuestion, "?", ["question-text"], 30, () => {
            addToHistory("QUESTION", selectedQuestion, null, "ZERO_GRAVITY");
            askZeroGravityQuestions(remainingCount - 1, finalCallback);
          });
        }

        /**
         * Initializes the machine.
         */
        function initializeMachine() {
          if (machineState.initialized) return;

          // Preserve 3D scene refs if they exist, reset the rest
          const existingScene = {
            matrixScene: machineState.matrixScene,
            matrixCamera: machineState.matrixCamera,
            matrixRenderer: machineState.matrixRenderer,
            matrixPoints: machineState.matrixPoints,
            matrixAnimationId: machineState.matrixAnimationId,
            animationInterval: machineState.animationInterval, // Also keep ASCII anim ref
          };

          machineState = {
            initialized: true,
            mode: "ZERO_GRAVITY",
            area: null,
            round: 0,
            maxRounds: 5, // Make sure maxRounds is set here too
            zeroGravityQuestionsAsked: 0,
            history: [],
            usedQuestions: {}, // Will be populated next
            // Restore scene refs
            ...existingScene,
          };
          initializeUsedQuestions();

          consoleOutput.innerHTML = "";
          historyLog.innerHTML = "";
          currentAreaDiv.style.display = "none";
          areaDescriptionDiv.style.display = "none";
          macromatrixHintDiv.style.display = "none";
          matrixData.innerHTML = "";
          stopAsciiAnimation(); // Stop potentially running animation

          writeToConsole(
            "Initializing WORLD MACHINE system...",
            ">",
            [],
            15,
            () => {
              writeToConsole(
                "System ready. Starting ZERO GRAVITY phase...",
                ">",
                [],
                15,
                () => {
                  const modeInfo = MODES[machineState.mode];
                  writeToConsole(
                    `Active mode: ${modeInfo.name}`,
                    ">",
                    [],
                    20,
                    () => {
                      writeToConsole(
                        modeInfo.description,
                        "...",
                        ["hint"],
                        20,
                        () => {
                          addToHistory("SYSTEM", "System initialized.");
                          addToHistory(
                            "MODE",
                            `Active mode: ${modeInfo.name}`,
                            null,
                            "ZERO_GRAVITY"
                          );
                          updateStatus();
                          updateButtons(); // Buttons still disabled, but state updated

                          askZeroGravityQuestions(
                            NUM_ZERO_GRAVITY_QUESTIONS,
                            () => {
                              updateStatus();
                              updateButtons(); // Enables 'Generate Zone'
                              startAsciiAnimation();
                              if (matrixDetails.open) {
                                initializeMatrixScene();
                              }
                            }
                          );
                        }
                      );
                    }
                  );
                }
              );
            }
          );
        }

        /**
         * Generates a new random zone.
         */
        function generateZone() {
          if (!machineState.initialized) return;
          if (
            machineState.mode !== "ZERO_GRAVITY" &&
            machineState.round < machineState.maxRounds
          )
            return;

          machineState.area = getRandomKey(AREAS);
          machineState.mode = null;
          machineState.round = 0;

          const areaInfo = AREAS[machineState.area];
          macromatrixHintDiv.style.display = "none";

          writeToConsole(
            `Activated new zone: ${areaInfo.name}`,
            "> ",
            [],
            20,
            () => {
              writeToConsole(
                `Starting question rounds for this zone (modes will be drawn randomly)...`,
                ">",
                [],
                20,
                () => {
                  showAreaInfo();
                  addToHistory(
                    "ZONE",
                    `Activated zone: ${areaInfo.name}`,
                    machineState.area
                  );
                  updateStatus();
                  updateButtons(); // Enables Question/Hint buttons
                }
              );
            }
          );
        }

        /**
         * Generates a question for the current zone and round.
         */
        function generateQuestion() {
          if (
            !machineState.initialized ||
            machineState.mode === "ZERO_GRAVITY" ||
            machineState.round >= machineState.maxRounds ||
            !machineState.area
          ) {
            return;
          }

          const roundModeKey = getRandomElement(ZONE_MODE_KEYS);
          machineState.mode = roundModeKey;
          const modeInfoRound = MODES[roundModeKey];
          writeToConsole(
            `Mode drawn for this round: ${modeInfoRound.name}`,
            ">",
            ["hint"],
            20
          );
          updateStatus();

          const areaKey = machineState.area;

          if (!QUESTIONS[areaKey] || !QUESTIONS[areaKey][roundModeKey]) {
            writeToConsole(
              `Error: No questions defined for Zone "${AREAS[areaKey]?.name}" and Mode "${modeInfoRound?.name}". Check the QUESTIONS structure.`,
              "> "
            );
            machineState.mode = null;
            updateStatus();
            return;
          }

          const questionPool = QUESTIONS[areaKey][roundModeKey];
          const usedInThisCombo =
            machineState.usedQuestions[areaKey]?.[roundModeKey]; // Safe navigation

          // Check if question pool exists and has questions
          if (!questionPool || questionPool.length === 0) {
            writeToConsole(
              `Warning: No questions in the pool for Zone "${
                AREAS[areaKey]?.name || "Unknown Zone"
              }" and Mode "${
                modeInfoRound?.name || "Unknown Mode"
              }". Insert questions in the code.`,
              "! "
            );
            machineState.round++;
            machineState.mode = null;
            updateStatus();
            updateButtons();
            if (machineState.round >= machineState.maxRounds && areaKey) {
              writeToConsole(
                `Finished rounds (${machineState.maxRounds}/${
                  machineState.maxRounds
                }) for zone ${AREAS[areaKey]?.name || "Unknown Zone"}.`,
                "> "
              );
              writeToConsole("You can now generate a new zone.", ">", [], 20);
            }
            return;
          }

          // Check if usedInThisCombo is initialized (it should be by initializeUsedQuestions)
          if (!usedInThisCombo) {
            console.error(
              `Error: usedQuestions structure not initialized for ${areaKey} / ${roundModeKey}`
            );
            // Attempt to initialize it defensively, though this indicates a logic error elsewhere
            if (!machineState.usedQuestions[areaKey])
              machineState.usedQuestions[areaKey] = {};
            machineState.usedQuestions[areaKey][roundModeKey] = [];
            // Now usedInThisCombo can be reassigned
            // usedInThisCombo = machineState.usedQuestions[areaKey][roundModeKey]; // Re-assign if needed, or just proceed
            // Decide how to handle - maybe just log error and return, or proceed assuming empty used list
            return; // Safer to return if structure was missing
          }

          const availableQuestions = questionPool.filter(
            (p) => !usedInThisCombo.includes(p)
          );

          let selectedQuestion;
          if (availableQuestions.length === 0) {
            writeToConsole(
              `Exhausted unique questions for Zone "${AREAS[areaKey].name}" and Mode "${modeInfoRound.name}". Drawing again from the full pool...`,
              "> "
            );
            selectedQuestion = getRandomElement(questionPool);
          } else {
            selectedQuestion = getRandomElement(availableQuestions);
            usedInThisCombo.push(selectedQuestion); // Mark as used
          }

          machineState.round++;

          writeToConsole(selectedQuestion, "?", ["question-text"], 30, () => {
            addToHistory("QUESTION", selectedQuestion, areaKey, roundModeKey);
            updateStatus();
            updateButtons();

            if (machineState.round >= machineState.maxRounds) {
              writeToConsole(
                `Finished rounds (${machineState.maxRounds}/${machineState.maxRounds}) for zone ${AREAS[areaKey].name}.`,
                "> "
              );
              writeToConsole("You can now generate a new zone.", ">", [], 20);
              machineState.mode = null;
              updateStatus();
            }
          });
        }

        // --- ASCII ANIMATION ---
        const asciiFrames = [
          "[ ■ □ □ □ □ □ □ □ □ □ ]",
          "[ □ ■ □ □ □ □ □ □ □ □ ]",
          "[ □ □ ■ □ □ □ □ □ □ □ ]",
          "[ □ □ □ ■ □ □ □ □ □ □ ]",
          "[ □ □ □ □ ■ □ □ □ □ □ ]",
          "[ □ □ □ □ □ ■ □ □ □ □ ]",
          "[ □ □ □ □ □ □ ■ □ □ □ ]",
          "[ □ □ □ □ □ □ □ ■ □ □ ]",
          "[ □ □ □ □ □ □ □ □ ■ □ ]",
          "[ □ □ □ □ □ □ □ □ □ ■ ]",
          "[ □ □ □ □ □ □ □ □ ■ □ ]",
          "[ □ □ □ □ □ □ □ ■ □ □ ]",
          "[ □ □ □ □ □ □ ■ □ □ □ ]",
          "[ □ □ □ □ □ ■ □ □ □ □ ]",
          "[ □ □ □ □ ■ □ □ □ □ □ ]",
          "[ □ □ □ ■ □ □ □ □ □ □ ]",
          "[ □ □ ■ □ □ □ □ □ □ □ ]",
          "[ ■ □ □ □ □ □ □ □ □ □ ]",
        ];
        let currentFrame = 0;

        function startAsciiAnimation() {
          stopAsciiAnimation();
          machineState.animationInterval = setInterval(() => {
            asciiAnimationDiv.textContent = asciiFrames[currentFrame];
            currentFrame = (currentFrame + 1) % asciiFrames.length;
          }, 150);
        }

        function stopAsciiAnimation() {
          if (machineState.animationInterval) {
            clearInterval(machineState.animationInterval);
            machineState.animationInterval = null;
            asciiAnimationDiv.textContent = "";
          }
        }

        // --- 3D MATRIX VISUALIZATION (Three.js) ---

        function initializeMatrixScene() {
          if (machineState.matrixRenderer) {
            onWindowResize();
            return;
          }
          const matrixContent3dDiv = matrixDetails.querySelector(
            ".matrix-content #matrix3d"
          );
          const targetElement = matrixContent3dDiv || matrix3dContainer; // Use inner div if exists

          // Clear previous canvas if any
          while (targetElement.firstChild) {
            targetElement.removeChild(targetElement.firstChild);
          }

          try {
            machineState.matrixScene = new THREE.Scene();
            machineState.matrixScene.background = new THREE.Color(0x000502);

            const width = targetElement.clientWidth || 400;
            const height = targetElement.clientHeight || 400; // Initial estimate
            machineState.matrixCamera = new THREE.PerspectiveCamera(
              75,
              width / height,
              0.1,
              1000
            );
            machineState.matrixCamera.position.z = 5;

            machineState.matrixRenderer = new THREE.WebGLRenderer({
              antialias: true,
            });
            machineState.matrixRenderer.setSize(width, height);
            targetElement.appendChild(machineState.matrixRenderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const numPoints = 5000;
            for (let i = 0; i < numPoints; i++) {
              vertices.push(
                (Math.random() - 0.5) * 10,
                (Math.random() - 0.5) * 10,
                (Math.random() - 0.5) * 10
              );
            }
            geometry.setAttribute(
              "position",
              new THREE.Float32BufferAttribute(vertices, 3)
            );

            const matrixColorCSS =
              getCssVariable("--matrix-color") || "#00ff41";
            const material = new THREE.PointsMaterial({
              color: matrixColorCSS,
              size: 0.05,
              transparent: true,
              opacity: 0.7,
              sizeAttenuation: true,
            });

            machineState.matrixPoints = new THREE.Points(geometry, material);
            machineState.matrixScene.add(machineState.matrixPoints);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            machineState.matrixScene.add(ambientLight);

            function animate() {
              if (machineState.matrixAnimationId)
                cancelAnimationFrame(machineState.matrixAnimationId);
              machineState.matrixAnimationId = requestAnimationFrame(animate);
              if (machineState.matrixPoints) {
                machineState.matrixPoints.rotation.x += 0.001;
                machineState.matrixPoints.rotation.y += 0.002;
              }
              if (
                machineState.matrixRenderer &&
                machineState.matrixScene &&
                machineState.matrixCamera
              ) {
                machineState.matrixRenderer.render(
                  machineState.matrixScene,
                  machineState.matrixCamera
                );
              }
            }
            animate();

            const resizeObserver = new ResizeObserver((entries) => {
              for (let entry of entries) {
                if (entry.target === targetElement) {
                  onWindowResize();
                }
              }
            });
            resizeObserver.observe(targetElement);
          } catch (error) {
            console.error("Three.js initialization error:", error);
            writeToConsole("Error initializing matrix visualization.", "! ");
            targetElement.innerHTML =
              '<p style="color: red; text-align: center; padding: 20px;">Cannot load 3D visualization.</p>';
          }
        }

        function onWindowResize() {
          const matrixContent3dDiv = matrixDetails.querySelector(
            ".matrix-content #matrix3d"
          );
          const targetElement = matrixContent3dDiv || matrix3dContainer; // Prefer inner div for size calculation

          if (
            machineState.matrixCamera &&
            machineState.matrixRenderer &&
            targetElement.clientWidth > 0
          ) {
            const width = targetElement.clientWidth;
            let height = 400; // Default

            if (matrixDetails.open) {
              // Use the targetElement's height as it should now reflect the visible space
              height =
                targetElement.clientHeight > 50
                  ? targetElement.clientHeight
                  : 400;
            } else {
              // If closed, maybe don't resize aggressively? Or use a small default.
              // Returning here keeps the last size, which might be fine.
              return;
            }

            machineState.matrixCamera.aspect = width / height;
            machineState.matrixCamera.updateProjectionMatrix();
            machineState.matrixRenderer.setSize(width, height);
          }
        }

        function addMatrixData(dataText) {
          const dataLine = document.createElement("div");
          dataLine.textContent = `> ${dataText}`;
          matrixData.appendChild(dataLine);
          matrixData.scrollTop = matrixData.scrollHeight;

          if (
            machineState.matrixScene &&
            machineState.matrixPoints?.geometry.attributes.position
          ) {
            const positions =
              machineState.matrixPoints.geometry.attributes.position;
            if (positions.count > 0) {
              const randomIndex = Math.floor(Math.random() * positions.count);
              const tempSphereGeo = new THREE.SphereGeometry(0.1, 8, 8);
              const tempSphereMat = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.9,
              });
              const tempSphere = new THREE.Mesh(tempSphereGeo, tempSphereMat);
              tempSphere.position.set(
                positions.getX(randomIndex),
                positions.getY(randomIndex),
                positions.getZ(randomIndex)
              );
              machineState.matrixScene.add(tempSphere);
              setTimeout(() => {
                if (machineState.matrixScene)
                  machineState.matrixScene.remove(tempSphere);
                tempSphereMat.dispose();
                tempSphereGeo.dispose();
              }, 500);
            }
          }
          addToHistory("MATRIX", dataText, machineState.area);
        }

        // --- EVENT LISTENERS ---
        btnInitialize.addEventListener("click", initializeMachine);
        btnArea.addEventListener("click", generateZone);
        btnQuestion.addEventListener("click", generateQuestion);
        btnHint.addEventListener("click", () => {
          if (
            !machineState.initialized ||
            machineState.mode === "ZERO_GRAVITY" ||
            machineState.round >= machineState.maxRounds ||
            !machineState.area
          )
            return;
          const hints = [
            "Pay attention to subtle changes...",
            "History hides more...",
            "The laws of physics might be flexible...",
            "Look for hidden patterns...",
            "Anomalies point to deeper truths...",
            "Resources aren't always what they seem...",
            "Time might flow differently...",
            "Technology and nature interact...",
          ];
          showHint(getRandomElement(hints));
        });

        matrixInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && matrixInput.value.trim() !== "") {
            if (!machineState.initialized) {
              writeToConsole("System is not initialized.", "! ");
              return;
            }
            addMatrixData(matrixInput.value.trim());
            matrixInput.value = "";
          }
        });

        matrixSubmit.addEventListener("click", function () {
          if (matrixInput.value.trim() !== "") {
            if (!machineState.initialized) {
              writeToConsole("System is not initialized.", "! ");
              return;
            }
            addMatrixData(matrixInput.value.trim());
            matrixInput.value = "";
          }
        });

        matrixDetails.addEventListener("toggle", function () {
          setTimeout(() => {
            if (
              matrixDetails.open &&
              machineState.initialized &&
              !machineState.matrixRenderer
            ) {
              initializeMatrixScene();
            } else if (matrixDetails.open && machineState.matrixRenderer) {
              onWindowResize(); // Ensure resize on reopen
            }
          }, 50);
        });

        // --- INITIAL STATE ---
        updateStatus();
        updateButtons();
        // initializeUsedQuestions is called inside initializeMachine now
      }); // End of DOMContentLoaded
    </script>
  </body>
</html>
